<div class="signDiv">
  <input type="text" id="signDiv-username" placeholder="Username" /><br />
  <input type="text" id="signDiv-password" placeholder="Password" /><br />
  <button id="signDiv-signIn">Sign in</button>
  <button id="signDiv-signUp">Sign up</button>
</div>
<div id="gameDiv" style="display: none">
  <canvas
    id="ctx"
    width="500"
    height="500"
    style="border: 1px solid black"
  ></canvas>

  <div id="chat-text" style="width: 500px; height: 100px; overflow-y: scroll">
    <div>Type something!</div>
  </div>

  <form id="chat-form">
    <input type="text" id="chat-input" style="width: 500px" />
  </form>
</div>

<script src="https://cdn.socket.io/4.0.1/socket.io.js"></script>
<script>
  const socket = io();

  //sign
  const signDiv = document.querySelector(".signDiv");
  const signDivUsername = document.getElementById("signDiv-username");
  const signDivPassword = document.getElementById("signDiv-password");
  const signIn = document.getElementById("signDiv-signIn");
  const signUp = document.getElementById("signDiv-signUp");
  const gameDiv = document.getElementById("gameDiv");

  signIn.onclick = () => {
    socket.emit("signIn", {
      username: signDivUsername.value,
      password: signDivPassword.value,
    });
  };
  signUp.onclick = () => {
    socket.emit("signUp", {
      username: signDivUsername.value,
      password: signDivPassword.value,
    });
  };
  socket.on("signInResponse", (data) => {
    if (data.success) {
      signDiv.style.display = "none";
      gameDiv.style.display = "inline-block";
    } else {
      signDivUsername.value = "";
      signDivPassword.value = "";
    }
  });
  socket.on("signUpResponse", (data) => {
    if (data.success) {
      alert("Sign up successful.");
    } else {
      alert("Sign up unsuccessful.");
    }
  });

  //chat
  const chatText = document.getElementById("chat-text");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");

  socket.on("addToChat", (data) => {
    chatText.innerHTML += `<div>${data}</div>`;
    chatText.scrollTop = chatText.scrollHeight;
  });

  socket.on("evalAnswer", (data) => {
    console.log(data);
  });

  chatForm.onsubmit = (event) => {
    event.preventDefault();
    if (chatInput.value[0] === "/") {
      socket.emit("evalServer", chatInput.value.slice(1));
    } else {
      socket.emit("sendMsgToServer", chatInput.value);
    }
    chatInput.value = "";
  };

  //game
  const ctx = document.getElementById("ctx").getContext("2d");
  ctx.fillStyle = "red";
  ctx.font = "30px Arial";

  const Player = (initPack) => {
    const self = {};
    self.id = initPack.id;
    self.number = initPack.number;
    self.x = initPack.x;
    self.y = initPack.y;
    self.hp = initPack.hp;
    self.hpMax = initPack.hpMax;
    self.score = initPack.score;

    self.draw = () => {
      ctx.fillText(self.number, self.x, self.y);
    };

    Player.list[self.id] = self;
    return self;
  };
  Player.list = {};

  const Bullet = (initPack) => {
    const self = {};
    self.id = initPack.id;
    self.x = initPack.x;
    self.y = initPack.y;

    self.draw = () => {
      ctx.fillRect(self.x - 2.5, self.y - 2.5, 5, 5);
    };

    Bullet.list[self.id] = self;
    return self;
  };
  Bullet.list = {};

  socket.on("init", (data) => {
    for (let i = 0; i < data.player.length; i++) {
      Player(data.player[i]);
    }
    for (let i = 0; i < data.bullet.length; i++) {
      Bullet(data.bullet[i]);
    }
  });

  socket.on("update", (data) => {
    for (let i = 0; i < data.player.length; i++) {
      const pack = data.player[i];
      const p = Player.list[pack.id];
      if (p) {
        if (pack.x !== undefined) p.x = pack.x;
        if (pack.y !== undefined) p.y = pack.y;
      }
    }
    for (let i = 0; i < data.bullet.length; i++) {
      const pack = data.bullet[i];
      const b = Bullet.list[data.bullet[i].id];
      if (b) {
        if (pack.x !== undefined) b.x = pack.x;
        if (pack.y !== undefined) b.y = pack.y;
      }
    }
  });
  socket.on("remove", (data) => {
    for (let i = 0; i < data.player.length; i++) {
      delete Player.list[data.player[i]];
    }
    for (let i = 0; i < data.bullet.length; i++) {
      delete Bullet.list[data.bullet[i]];
    }
  });

  setInterval(() => {
    ctx.clearRect(0, 0, 500, 500);
    for (let i in Player.list) {
      ctx.fillText(Player.list[i].number, Player.list[i].x, Player.list[i].y);
    }
    for (let i in Bullet.list) {
      ctx.fillRect(Bullet.list[i].x - 2.5, Bullet.list[i].y - 2.5, 5, 5);
    }
  }, 40);

  document.onkeydown = (event) => {
    if (event.keyCode === 68)
      socket.emit("keyPress", { inputId: "right", state: true });
    else if (event.keyCode === 83)
      socket.emit("keyPress", { inputId: "down", state: true });
    else if (event.keyCode === 65)
      socket.emit("keyPress", { inputId: "left", state: true });
    else if (event.keyCode === 87)
      socket.emit("keyPress", { inputId: "up", state: true });
  };
  document.onkeyup = (event) => {
    if (event.keyCode === 68)
      socket.emit("keyPress", { inputId: "right", state: false });
    else if (event.keyCode === 83)
      socket.emit("keyPress", { inputId: "down", state: false });
    else if (event.keyCode === 65)
      socket.emit("keyPress", { inputId: "left", state: false });
    else if (event.keyCode === 87)
      socket.emit("keyPress", { inputId: "up", state: false });
  };

  document.onmousedown = (event) => {
    socket.emit("keyPress", { inputId: "attack", state: true });
  };
  document.onmouseup = (event) => {
    socket.emit("keyPress", { inputId: "attack", state: false });
  };
  document.onmousemove = (event) => {
    const x = -250 + event.clientX - 8;
    const y = -250 + event.clientY - 8;
    const angle = (Math.atan2(y, x) / Math.PI) * 180;
    socket.emit("keyPress", { inputId: "mouseAngle", state: angle });
  };
</script>
